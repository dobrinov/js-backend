<!doctype html>
<html lang="en">
  <head>
    <title>GraphiQL</title>
    <style>
      #root {
        height: 100vh;
      }
    </style>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script
      src="https://unpkg.com/graphiql/graphiql.min.js"
      type="application/javascript"
    ></script>
    <link rel="stylesheet" href="https://unpkg.com/graphiql/graphiql.min.css" />
  </head>

  <body>
    <div id="root">Loading...</div>
    <script>
      const email =
        new URLSearchParams(window.location.search).get("email") ??
        "admin@example.com";

      fetch("http://localhost:8080/session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: "1" }),
      }).then((response) => {
        if (response.ok) {
          response.text().then((token) => {
            localStorage.setItem(
              "graphiql:headers",
              JSON.stringify({ Authorization: `Bearer ${token}` })
            );
            renderGraphiQL(token);
          });
        } else {
          console.error("Failed to authenticate");
        }
      });

      function renderGraphiQL(token) {
        const fetcher = GraphiQL.createFetcher({
          url: "http://localhost:8080/graph",
          headers: { Authorization: `Bearer ${token}` },
        });
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(React.createElement(GraphiQL, { fetcher }));
      }
    </script>
  </body>
</html>
